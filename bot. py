import os
import json
import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters

BOT_TOKEN = os.environ.get('BOT_TOKEN', '')
API_KEY = os.environ.get('API_KEY', 'da09d217da2fdced06d6d04d339e8ada')
SERVICE_ID = os.environ.get('SERVICE_ID', '78')
DEFAULT_QUANTITY = int(os.environ.get('DEFAULT_QUANTITY', '100'))
ADMIN_ID = int(os.environ.get('ADMIN_ID', '5825614198'))

channels = {}

def is_admin(user_id):
    return user_id == ADMIN_ID

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        await update.message.reply_text("â›” Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø®Ø§Øµ.")
        return
    await update.message.reply_text("ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹!\n\n/addchannel - Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©\n/channels - Ø§Ù„Ù‚Ù†ÙˆØ§Øª\n/balance - Ø§Ù„Ø±ØµÙŠØ¯")

async def balance(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return
    try:
        r = requests.post("https://fixedmember.com/api/v2", data={"key": API_KEY, "action": "balance"}).json()
        await update.message.reply_text(f"ğŸ’° Ø±ØµÙŠØ¯Ùƒ: ${r.get('balance', 'N/A')}")
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø£: {e}")

async def addchannel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return
    await update.message.reply_text("ğŸ“¢ Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ù†Ø§Ø©\nÙ…Ø«Ø§Ù„: @channelname")
    context.user_data['waiting_for'] = 'channel_id'

async def show_channels(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return
    if not channels:
        await update.message.reply_text("ğŸ“¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª.\n/addchannel Ù„Ø¥Ø¶Ø§ÙØ©")
        return
    text = "ğŸ“¢ Ø§Ù„Ù‚Ù†ÙˆØ§Øª:\n\n"
    for ch_id, ch_data in channels.items():
        text += f"âœ… {ch_id} - Ø§Ù„ÙƒÙ…ÙŠØ©: {ch_data['quantity']}\n"
    await update.message.reply_text(text)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return
    if context.user_data.get('waiting_for') == 'channel_id':
        channel_id = update.message.text.strip()
        channels[channel_id] = {'quantity': DEFAULT_QUANTITY, 'enabled': True}
        context.user_data['waiting_for'] = None
        await update.message.reply_text(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ©: {channel_id}")

async def handle_channel_post(update: Update, context: ContextTypes.DEFAULT_TYPE):
    post = update.channel_post
    if not post:
        return
    chat = post.chat
    channel_id = f"@{chat.username}" if chat.username else str(chat.id)
    channel_data = None
    for ch_id in channels:
        if ch_id in [channel_id, chat.username, f"@{chat.username}"]:
            channel_data = channels[ch_id]
            break
    if not channel_data:
        return
    post_link = f"https://t.me/{chat.username}/{post.message_id}" if chat.username else f"https://t.me/c/{str(chat.id).replace('-100', '')}/{post.message_id}"
    try:
        r = requests.post("https://fixedmember.com/api/v2", data={"key": API_KEY, "action": "add", "service": SERVICE_ID, "link": post_link, "quantity": channel_data['quantity']}).json()
        msg = f"âœ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!\nğŸ“¢ {channel_id}\nğŸ”— {post_link}\nğŸ”¢ {r.get('order', 'N/A')}" if r.get('order') else f"âŒ Ø®Ø·Ø£: {r.get('error')}"
        await context.bot.send_message(ADMIN_ID, msg)
    except Exception as e:
        await context.bot.send_message(ADMIN_ID, f"âŒ Ø®Ø·Ø£: {e}")

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("balance", balance))
    app.add_handler(CommandHandler("addchannel", addchannel))
    app.add_handler(CommandHandler("channels", show_channels))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_handler(MessageHandler(filters.UpdateType.CHANNEL_POST, handle_channel_post))
    print("âœ… Bot started!")
    app.run_polling()

if __name__ == "__main__":
    main()
